apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: copy-namespace-labels
  annotations:
    policies.kyverno.io/title: Copy Namespace Labels
    policies.kyverno.io/category: Example
spec:
  validationFailureAction: Enforce
  background: false
  rules:
    - name: copy-owner-label-to-deployment
      match:
        any:
          - resources:
              kinds:
                - Deployment
              namespaces:
                - kyv-testing
      context:
        - name: owner
          apiCall:
            urlPath: "/api/v1/namespaces/{{ request.object.metadata.namespace }}"
            jmesPath: metadata.labels.owner || 'none'
      mutate:
        patchStrategicMerge:
          metadata:
            labels:
              owner: "{{ owner }}"

    - name: copy-all-ns-labels-to-deployment
      match:
        any:
          - resources:
              kinds:
                - Deployment
              namespaces:
                - kyv-testing
      context:
        - name: all_labels
          apiCall:
            urlPath: "/api/v1/namespaces/{{ request.object.metadata.namespace }}"
            jmesPath: metadata.labels | merge(@, {"kubernetes.io/metadata.name":null})
      mutate:
        patchStrategicMerge:
          metadata:
            labels:
              "{{ all_labels }}"
