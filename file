resource "aws_instance" "this" {
  for_each = {
    for service_name, service_config in var.services :
    service_name => [
      for i in range(service_config.replicas) :
      {
        ami                  = data.aws_ami.ami_filter[service_name].id
        instance_type        = service_config.instance_type
        key_name             = service_config.key_name
        subnet_id            = var.available_subnets[service_config.subnet_name]
        iam_instance_profile = service_config.iam_instance_profile
        associate_public_ip_address = true
        ebs_optimized        = true
        user_data            = service_config.user_data

        root_block_device {
          delete_on_termination = true
          encrypted             = false
          iops                  = service_config.root_volume_iops
          throughput            = service_config.root_volume_throughput
          volume_size           = service_config.root_volume_size
          volume_type           = "gp3"
          tags = merge(
            service_config.volume_tags
          )
        }

        lifecycle {
          ignore_changes = [user_data, associate_public_ip_address]
        }

        metadata_options {
          http_endpoint          = "enabled"
          instance_metadata_tags = "enabled"
        }

        tags = merge(
          service_config.tags,
          { "Name" = format("%s-%02d", service_name, i + 1) }
        )
      }
    ]
  }

  instance_type        = each.value.instance_type
  key_name             = each.value.key_name
  ami                  = each.value.ami
  subnet_id            = each.value.subnet_id
  iam_instance_profile = each.value.iam_instance_profile
  associate_public_ip_address = each.value.associate_public_ip_address
  ebs_optimized        = each.value.ebs_optimized
  user_data            = each.value.user_data

  root_block_device {
    delete_on_termination = each.value.root_block_device.delete_on_termination
    encrypted             = each.value.root_block_device.encrypted
    iops                  = each.value.root_block_device.iops
    throughput            = each.value.root_block_device.throughput
    volume_size           = each.value.root_block_device.volume_size
    volume_type           = each.value.root_block_device.volume_type
    tags = each.value.root_block_device.tags
  }

  metadata_options {
    http_endpoint          = each.value.metadata_options.http_endpoint
    instance_metadata_tags = each.value.metadata_options.instance_metadata_tags
  }

  tags = each.value.tags
}
